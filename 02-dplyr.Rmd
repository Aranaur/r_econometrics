# Маніпуляції з даними за допомогою dplyr {#dplyr}
***
```{r setup-02, echo = FALSE, purl = FALSE, cache = FALSE, include=FALSE}
knitr::opts_knit$set(global.par = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, collapse = TRUE, out.width = '100%')
```

В минулій главі ми розібрали основні принципи мови програмування R. І тут слід зазначити, що окрім базового синтаксису існують й інші. Загалом, можна виділити три основні діалекти в мові програмування R:
* base: основний фундамент мови, який ми розібрали (але не повністю) раніше.
* Tidyverse: окремий напрямок розвитку мови програмування R, що сконцентрований у напрямку науки про дані (data science).
* data.table: альтернативний напрямок, який дозволяє оброблювати об'ємні масиви даних за рекордний час @h2obench.

Їх можна сміло поєднувати в своїх проектах, що значним чином підвищує ефективність та швидкість роботи.

##  Tidy-всесвіт {#tidy}
***
[**Tidyverse**](https://www.tidyverse.org/) --- це екосистема, набір пакетів, які спеціально створені для науки про дані (data science). В ньому є ключові пакети (ядро tidyverse) та побічні --- які додатково розширюють можливості мови програмування R.

**Концепція охайних даних (tidy-data)** передбачає приведення даних до формату, в якому:
- Кожна змінна міститься в окремому стовпчику
- Кожне спостереження міститься в окремому рядку
- Кожне значення міститься в окремій комірці

**Ядро tidyverse:**
- *ggplot2*, для візуалізації
- *dplyr*, для маніпуляції з даними
- *tidyr*, для отримання охайних даних (tidy data)
- *readr*, для зчитування та записування файлів в R
- *purrr*, для функціонального програмування
- *tibble*, для роботи з тібблами (tibble), просунутий варіант дата фреймів
- *stringr*, для роботи з текстовими даними
- *forcats*, для роботи з факторами (factors)

Крім того є ще низка допоміжних пакетів, які не входять до ядра tidyverse але вважаються його частиною:
- *vroom*, для швидкого завантаження даних
- *DBI*, для роботи з базами даних
- *haven*, для даних SPSS, Stata та SAS
- *httr*, для роботи з API
- *readxl* для завантаження .xls та .xlsx файлів
- *googlesheets4*, для роботи з Google Sheet
- *googledrive*, для роботи з Google Drive
- *rvest*, для скрапінгу веб-сторінок
- *jsonlite*, для роботи з JSON-файлами
- *xml2*, для роботи з XML
- *lubridate*, для роботи з датами
- *dbplyr*, для перетворення коду `dplyr` в SQL
- *dtplyr*, для перетворення коду на `data.table`
- *magrittr*, для використання конвеєрів `%>%` (pipe)
- *glue*, для поєднання даних та тексту
- *tidymodels*, для роботи з моделями машнинного навчання.

І це ще не повний список. Крім офіційних пакетів tidyverse є ще низка пакетів, які намагаються відповідати принципам tidyverse і доповнюють його.

Для завантаження tidyverse необхідно виконати наступний код:
```{r tidyinstall, eval=FALSE}
install.packages("tidyverse")
```
Для підключення:
```{r tidyload, eval=FALSE}
library("tidyverse")
```

Концепція "охайних" даних передбачає альтернативу класичним `data.frame` у вигляді тібблів (`tibble`). Давайте розеберемо основі відмінності.
В мові програмування R є вбудований популярний датасет `iris`. Він зберігається в форматі дата фрейму.
```{r iris}
# Переглянемо перші декілька значень
head(iris)
```

Давайте створемо його альтернативу у вигляді тібблу:
```{r iristbl}
iris_tbl <- as_tibble(iris)
iris_tbl
```

Вже на цьому етапі 

Головним чином, для роботи з даними, я зосереджу свою увагу на роботі з пакетом `dplyr`.

## Завантаження даних {#tidy_read}
***
### Завантаження .csv, .tsv файлів {#tidy_csv}
Стандартною функцією завантаження даних типу `.csv` є функція `read.csv()`, але на досить великих масивах даних краще використовувати `read_csv()` з пакету `readr`. Синтаксис цих функцій схожий, але `read_csv()` одразу приведе дані до формату `tibble`.
Першим аргументом функції є шлях до файлу (із оберненим слешем `/`). Також можна використовувати прямі URL-посилання на файл: 
```{r eval=FALSE}
read_file <- read_csv("docs/data/file.csv")
read_url <- read_csv("https://git.io/JztOr")
```

Аналогічно до `read_csv()` можна використовувати функцію `vroom` з однойменного пакету. Головною особливістю цього пакету є [швидкість завантаження даних](https://cran.r-project.org/web/packages/vroom/vignettes/benchmarks.html).
```{r eval=FALSE}
vroom_file <- vroom("docs/data/file.csv")
vroom_url <- vroom("https://git.io/JztOr")
```

Для **завантаження** одночасно **декількох файлів однакової структури** корисно використовувати наступну конструкцію
```{r eval=FALSE}
filse <- dir(pattern = "\\.csv$")
vroom_all <- vroom(filse)
```

### Завантаження .xls, .xlsx файлів {#tidy_xls}
Для завантаження файлів **Excel** використовується пакет `readxl` та функція `read_excel()`.
На початку можна отримати перелік листів файлу Excel за допомогою функції `excel_sheets()`
```{r}
readxl::excel_sheets("docs/data/tourism.xlsx")
```
Після чого зчитати данні з потрібного листа
```{r eval=FALSE}
excel_file <- read_excel("docs/data/tourism.xlsx", sheet = "Sheet1")
```

В більшості випадків цього інструментарію має бути достатньо, але для завантаження специфічних файлів завжди можна знайти потрібний пакет. Не соромтеся використовувати google.


## Маніпуляції з даними за допомогою пакету dplyr {#dplyr}
***
dplyr - це граматика маніпуляції з даними, яка має низку функцій, які допоможуть легко та зручно маніпулювати даними, наприклад:
* створювати нові змінні
* сортувати дані
* проводити фільтрацію даних
* агрегування даних і багато іншого.

В якості прикладу роботи з пакетом dplyr пропоную використати датасет `gapminder` з однойменного пакету. В ньому збережена інформація про ВВП, очікувану тривалість життя при народженні та населення для 142 країн світу з 1952 по 2007 роки.
```{r gapminder}
# Підключемо пакет (не забудьте його встановити) та подивимось на датасет
library(gapminder)
gapminder
```

Видно, що змінні `country` та `continent` --- це фактори, а всі інші - числові.

### dplyr::filter() {#filter}
Для фільтрації даних використовується функція `filter()`:
